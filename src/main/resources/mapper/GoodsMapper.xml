<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.xianzhiyun.mapper.GoodsMapper">

    <!-- 基础商品结果映射（增加 item_type -> itemType） -->
    <resultMap id="GoodsResultMap" type="com.example.xianzhiyun.entity.GoodsItem">
        <id column="id" property="id" />
        <result column="seller_id" property="sellerId" />
        <result column="title" property="title" />
        <result column="description" property="description" />
        <result column="price" property="price" />
        <result column="category" property="category" />
        <result column="cover_urls" property="coverUrls" />
        <result column="item_type" property="itemType" />
        <result column="status" property="status" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="is_deleted" property="isDeleted" />
    </resultMap>

    <!-- Admin专用的结果映射，继承GoodsResultMap，并假设GoodsItem或其DTO中包含sellerName字段 -->
    <resultMap id="AdminGoodsResultMap" type="com.example.xianzhiyun.entity.GoodsItem" extends="GoodsResultMap">
        <result column="seller_nickname" property="sellerName" />
    </resultMap>

    <!-- Admin查询的通用列，包含卖家昵称 -->
    <sql id="AdminGoodsColumns">
        g.id, g.seller_id, g.title, g.description, g.price, g.category, g.cover_urls, g.item_type, g.status, g.create_time, g.update_time, g.is_deleted, u.nickname AS seller_nickname
    </sql>

    <!-- 管理端商品列表查询 -->
    <select id="listGoodsForAdmin" resultMap="AdminGoodsResultMap" parameterType="map">
        SELECT
        <include refid="AdminGoodsColumns" />
        FROM goods_item g
        LEFT JOIN user_info u ON g.seller_id = u.id
        <where>
            g.is_deleted = 0
            <if test="status != null and status != ''">
                AND g.status = #{status}
            </if>
            <if test="sellerId != null">
                AND g.seller_id = #{sellerId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (g.title LIKE CONCAT('%', #{keyword}, '%')
                OR g.description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="category != null and category != ''">
                AND g.category = #{category}
            </if>
            <if test="sellerKeyword != null and sellerKeyword != ''">
                AND (u.nickname LIKE CONCAT('%', #{sellerKeyword}, '%') OR CAST(g.seller_id AS CHAR) LIKE CONCAT('%', #{sellerKeyword}, '%'))
            </if>
        </where>
        ORDER BY g.create_time DESC
        <if test="limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <!-- 管理端商品列表计数 -->
    <select id="countGoodsForAdmin" resultType="int" parameterType="map">
        SELECT COUNT(1)
        FROM goods_item g
        LEFT JOIN user_info u ON g.seller_id = u.id
        <where>
            g.is_deleted = 0
            <if test="status != null and status != ''">
                AND g.status = #{status}
            </if>
            <if test="sellerId != null">
                AND g.seller_id = #{sellerId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (g.title LIKE CONCAT('%', #{keyword}, '%')
                OR g.description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="category != null and category != ''">
                AND g.category = #{category}
            </if>
            <if test="sellerKeyword != null and sellerKeyword != ''">
                AND (u.nickname LIKE CONCAT('%', #{sellerKeyword}, '%') OR CAST(g.seller_id AS CHAR) LIKE CONCAT('%', #{sellerKeyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 以下为用户端或通用查询，包含 item_type 支持 -->

    <!-- 根据参数构造通用商品列表（带 is_deleted 过滤） -->
    <select id="selectGoodsList" resultMap="GoodsResultMap" parameterType="map">
        SELECT id, seller_id, title, description, price, category, cover_urls, item_type, status, create_time, update_time, is_deleted
        FROM goods_item
        <where>
            AND is_deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%')
                OR description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="category != null and category != ''">
                AND category = #{category}
            </if>

            <!-- 优先使用精确的 item_type 过滤；若没有 itemType，再使用 filterKeywords 回退模糊匹配 -->
            <choose>
                <when test="itemType != null and itemType != ''">
                    AND item_type = #{itemType}
                </when>
                <when test="filterKeywords != null">
                    AND (
                    <foreach collection="filterKeywords" item="kw" open="(" separator=" OR " close=")">
                        (title LIKE CONCAT('%', #{kw}, '%')
                        OR description LIKE CONCAT('%', #{kw}, '%')
                        OR category LIKE CONCAT('%', #{kw}, '%')
                        OR cover_urls LIKE CONCAT('%', #{kw}, '%'))
                    </foreach>
                    )
                </when>
            </choose>

        </where>
        ORDER BY create_time DESC
        <if test="limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <select id="selectGoodsCount" resultType="int" parameterType="map">
        SELECT COUNT(1)
        FROM goods_item
        <where>
            AND is_deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%')
                OR description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="category != null and category != ''">
                AND category = #{category}
            </if>

            <choose>
                <when test="itemType != null and itemType != ''">
                    AND item_type = #{itemType}
                </when>
                <when test="filterKeywords != null">
                    AND (
                    <foreach collection="filterKeywords" item="kw" open="(" separator=" OR " close=")">
                        (title LIKE CONCAT('%', #{kw}, '%')
                        OR description LIKE CONCAT('%', #{kw}, '%')
                        OR category LIKE CONCAT('%', #{kw}, '%')
                        OR cover_urls LIKE CONCAT('%', #{kw}, '%'))
                    </foreach>
                    )
                </when>
            </choose>

        </where>
    </select>

    <select id="selectBySellerId" resultMap="GoodsResultMap" parameterType="map">
        SELECT id, seller_id, title, description, price, category, cover_urls, item_type, status, create_time, update_time, is_deleted
        FROM goods_item
        WHERE seller_id = #{sellerId} AND is_deleted = 0
        ORDER BY create_time DESC
            LIMIT #{offset}, #{limit}
    </select>

    <select id="countBySellerId" resultType="int" parameterType="long">
        SELECT COUNT(1)
        FROM goods_item
        WHERE seller_id = #{sellerId} AND is_deleted = 0
    </select>

    <select id="selectById" resultMap="GoodsResultMap" parameterType="long">
        SELECT id, seller_id, title, description, price, category, cover_urls, item_type, status, create_time, update_time, is_deleted
        FROM goods_item
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <insert id="insert" parameterType="com.example.xianzhiyun.entity.GoodsItem" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO goods_item (seller_id, title, description, price, category, cover_urls, item_type, status, create_time, update_time, is_deleted)
        VALUES (#{sellerId}, #{title}, #{description}, #{price}, #{category}, #{coverUrls}, #{itemType}, #{status}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, #{isDeleted})
    </insert>

    <update id="update" parameterType="com.example.xianzhiyun.entity.GoodsItem">
        UPDATE goods_item
        SET title = #{title},
            description = #{description},
            price = #{price},
            category = #{category},
            cover_urls = #{coverUrls},
            item_type = #{itemType},
            status = #{status},
            update_time = CURRENT_TIMESTAMP
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 逻辑删除：设置 is_deleted = 1 -->
    <update id="logicalDelete" parameterType="long">
        UPDATE goods_item
        SET is_deleted = 1,
            update_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
          AND is_deleted = 0
    </update>

    <select id="selectByIds" resultMap="GoodsResultMap" parameterType="list">
        SELECT id, seller_id, title, description, price, category, cover_urls, item_type, status, create_time, update_time, is_deleted
        FROM goods_item
        WHERE id IN
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND is_deleted = 0
    </select>

</mapper>